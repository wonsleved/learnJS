# Variable scope, closure

(Everything is not for `var`, only `let` or `const`)

## Code blocks

If a variable is declared inside a code block `{...}`, it’s only visible inside that block.

## Nested functions

A function is called “nested” when it is created inside another function.

## Lexical Environment

### Step 1. Variables

In JavaScript, every running function, code block `{...}`, and the script as a whole have an internal (hidden) associated object known as the *Lexical Environment*.

The Lexical Environment object consists of two parts:

1. *Environment Record* – an object that stores all local variables as its properties (and some other information like the value of `this`).
2. A reference to the *outer lexical environment*, the one associated with the outer code.

**A “variable” is just a property of the special internal object, *Environment Record*. “To get or change a variable” means “to get or change a property of that object”.**

***Lexical Environment is a specification object.***
It only exists “theoretically”.

### Step 2. Function Declarations

**The difference is that a Function Declaration is instantly fully initialized.**

### Step 3. Inner and outer Lexical Environment

**When the code wants to access a variable – the inner Lexical Environment is searched first, then the outer one, then the more outer one and so on until the global one.**

### Step 4. Returning a function

All functions remember the Lexical Environment in which they were made.

All functions have the hidden property named `[[Environment]]`, that keeps the reference to the Lexical Environment where the function was created.

**A variable is updated in the Lexical Environment where it lives.**

***Closure***

A closure is a function that remembers its outer variables and can access them.

## Garbage collection

Lexical Environment is removed from memory with all the variables after the function call finishes. That’s because there are no references to it.

If there’s a nested function that is still reachable after the end of a function, then it has `[[Environment]]` property that references the lexical environment.

### Real-life optimizations

**An important side effect in V8 (Chrome, Edge, Opera) is that such variable will become unavailable in debugging.**

